<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Efficient LOO and WAIC for Bayesian models — loo-package • loo</title>

<!-- jquery -->
<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script>
<!-- Bootstrap -->
<link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<!-- Font Awesome icons -->
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">


<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script>
<script src="../pkgdown.js"></script>
  
  
<!-- mathjax -->
<script src='https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->


  </head>

  <body>
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">loo</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Other Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="http://mc-stan.org/rstan">rstan</a>
    </li>
    <li>
      <a href="http://mc-stan.org/rstanarm">rstanarm</a>
    </li>
    <li>
      <a href="http://mc-stan.org/bayesplot">bayesplot</a>
    </li>
    <li>
      <a href="http://mc-stan.org/shinystan">shinystan</a>
    </li>
    <li>
      <a href="http://mc-stan.org/rstantools">rstantools</a>
    </li>
  </ul>
</li>
<li>
  <a href="http://mc-stan.org">Stan</a>
</li>
      </ul>
      
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://twitter.com/mcmc_stan">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/stan-dev/rstanarm">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="http://discourse.mc-stan.org/">
    <span class="fa fa-users"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header>

      <div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Efficient LOO and WAIC for Bayesian models</h1>
    </div>

    
    <p><img src='figures/stanlogo.png' width="50px" alt="mc-stan.org" />
  <em>Stan Development Team</em></p>
<p>This package implements the methods described in Vehtari, Gelman,
and Gabry (2017). The package documentation is largely based on excerpts
from the paper.</p>
    

        
    <h2 class="hasAnchor" id="summary"><a class="anchor" href="#summary"></a>Summary</h2>

    <p>Leave-one-out cross-validation (LOO) and the widely
  applicable information criterion (WAIC) are methods for estimating
  pointwise out-of-sample prediction accuracy from a fitted Bayesian model
  using the log-likelihood evaluated at the posterior simulations of the
  parameter values. LOO and WAIC have various advantages over simpler
  estimates of predictive error such as AIC and DIC but are less used in
  practice because they involve additional computational steps. This package
  implements the fast and stable computations for LOO and WAIC laid out in
  Vehtari, Gelman, and Gabry (2017). From existing posterior simulation
  draws, we compute LOO using Pareto Smoothed Importance Sampling (PSIS;
  Vehtari, Gelman, and Gabry, 2016), a new procedure for regularizing
  importance weights. As a byproduct of our calculations, we also obtain
  approximate standard errors for estimated predictive errors and for
  comparing of predictive errors between two models.</p>
    
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>After fitting a Bayesian model we often want to measure its
  predictive accuracy, for its own sake or for purposes of model comparison,
  selection, or averaging. Cross-validation and information criteria are two
  approaches for estimating out-of-sample predictive accuracy using
  within-sample fits.</p>
<p>Exact cross-validation requires re-fitting the model with different
  training sets. Approximate leave-one-out cross-validation (LOO) can be
  computed easily using importance sampling (Gelfand, Dey, and Chang, 1992,
  Gelfand, 1996) but the resulting estimate is noisy, as the variance of the
  importance weights can be large or even infinite (Peruggia, 1997, Epifani
  et al., 2008). Here we propose a novel approach that provides a more
  accurate and reliable estimate using importance weights that are smoothed
  by fitting a generalized Pareto distribution to the upper tail of the
  distribution of the importance weights.</p>
<p>WAIC (the widely applicable or Watanabe-Akaike information criterion;
  Watanabe, 2010) can be viewed as an improvement on the deviance information
  criterion (DIC) for Bayesian models. DIC has gained popularity in recent
  years in part through its implementation in the graphical modeling package
  BUGS (Spiegelhalter, Best, et al., 2002; Spiegelhalter, Thomas, et al.,
  1994, 2003), but it is known to have some problems, arising in part from it
  not being fully Bayesian in that it is based on a point estimate (van der
  Linde, 2005, Plummer, 2008). For example, DIC can produce negative
  estimates of the effective number of parameters in a model and it is not
  defined for singular models. WAIC is fully Bayesian and closely
  approximates Bayesian cross-validation. Unlike DIC, WAIC is invariant to
  parametrization and also works for singular models. WAIC is asymptotically
  equal to LOO, and can thus be used as an approximation to LOO. In the
  finite case, WAIC and LOO often give very similar estimates, but for
  influential observations WAIC underestimates the effect of leaving out one
  observation.</p>
<p>One advantage of AIC and DIC has been their computational simplicity. In
  this package we present fast and stable computations for LOO and WAIC that
  can be performed directly on posterior simulations, thus allowing these
  newer tools to enter routine statistical practice. As a byproduct of our
  calculations, we also obtain approximate standard errors for estimated
  predictive errors and for the comparison of predictive errors between two
  models.</p>
    
    <h2 class="hasAnchor" id="psis-loo"><a class="anchor" href="#psis-loo"></a>PSIS-LOO</h2>

    <p>The distribution of the importance weights used in LOO may
  have a long right tail. We use the empirical Bayes estimate of Zhang and
  Stephens (2009) to fit a generalized Pareto distribution (gPd) to the tail
  (20% largest importance ratios). By examining the shape parameter \(k\)
  of the fitted gPd, we are able to obtain sample based estimates of the
  existance of the moments (Koopman et al, 2009). This extends the diagnostic
  approach of Peruggia (1997) and Epifani et al. (2008) to be used routinely
  with importance-sampling LOO for any model with a factorizing likelihood.</p>
<p>Epifani et al. (2008) show that when estimating the leave-one-out
  predictive density, the central limit theorem holds if the variance of the
  weight distribution is finite. These results can be extended using the
  generalized central limit theorem for stable distributions. Thus, even if
  the variance of the importance weight distribution is infinite, if the mean
  exists the estimate's accuracy improves when additional draws are obtained.
  When the tail of the weight distribution is long, a direct use of
  importance sampling is sensitive to one or few largest values. By fitting a
  gPd to the upper tail of the importance weights we smooth these values. The
  procedure (implemented in the <code><a href='psislw.html'>psislw</a></code> function) goes as
  follows:</p><ol>
<li><p>Fit the gPd to the 20% largest importance ratios \(r_s\). The
  computation is done separately for each held-out data point \(i\). In
  simulation experiments with thousands and tens of thousands of draws, we
  have found that the fit is not sensitive to the specific cutoff value (for
  a consistent estimation the proportion of the samples above the cutoff
  should get smaller when the number of draws increases).</p></li>
<li><p>Stabilize the importance ratios by replacing the \(M\) largest
  ratios by the expected values of the order statistics of the fitted
  gPd $$G((z - 0.5)/M), z = 1,...,M,$$ where
  \(M\) is the number of simulation draws used to fit the Pareto (in this
  case, \(M = 0.2*S\)) and \(G\) is the inverse-CDF of the gPd.</p></li>
<li><p>To guarantee finite variance of the estimate, truncate the smoothed
  ratios with $$S^{3/4}\bar{w},$$ where \(\bar{w}\) is the average of
  the smoothed weights.</p></li>
</ol>
    <p>The above steps must be performed for each data point \(i\). The result is
a vector of weights \(w_{i}^{s}, s = 1,...,S\), for each \(i\), which in
general should be better behaved than the raw importance ratios
\(r_{i}^{s}\) from which they were constructed.</p>
<p>The results can be then combined to compute the desired LOO estimates.</p>
    
    <h2 class="hasAnchor" id="pareto-k-diagnostic"><a class="anchor" href="#pareto-k-diagnostic"></a>Pareto k diagnostic</h2>

    <p>The reliability of the PSIS-based estimates can
  be assessed using the estimates for the shape parameter \(k\) of the
  generalized Pareto distribution.</p><ul>
<li><p>If \(k &lt; 1/2\) the variance of the raw importance ratios is finite,
  the central limit theorem holds, and the estimate converges quickly.</p></li>
<li><p>If \(k\) is between 1/2 and 1 the variance of the raw importance
  ratios is infinite but the mean exists, the generalized central limit
  theorem for stable distributions holds, and the convergence of the estimate
  is slower. The variance of the PSIS estimate is finite but may be large.</p></li>
<li><p>If \(k &gt; 1\) the variance and the mean of the raw ratios
  distribution do not exist. The variance of the PSIS estimate is finite but
  may be large.</p></li>
</ul>
    <p>If the estimated tail shape parameter \(k\) exceeds \(0.5\), the user
should be warned, although in practice we have observed good performance for
values of \(k\) up to 0.7. Even if the PSIS estimate has a finite variance,
the user should consider sampling directly from \(p(\theta^s | y_{-i})\)
for the problematic \(i\), use \(k\)-fold cross-validation, or use a more
robust model.</p>
<p>Importance sampling is likely to work less well if the marginal posterior
\(p(\theta^s | y)\) and LOO posterior \(p(\theta^s | y_{-i})\) are much
different, which is more likely to happen with a non-robust model and highly
influential observations. A robust model may reduce the sensitivity to highly
influential observations.</p>
    
    <h2 class="hasAnchor" id="references"><a class="anchor" href="#references"></a>References</h2>

    <p>Vehtari, A., Gelman, A., and Gabry, J. (2017). Practical
  Bayesian model evaluation using leave-one-out cross-validation and WAIC.
  <em>Statistics and Computing</em>. 27(5), 1413--1432.
  doi:10.1007/s11222-016-9696-4.
  (<a href = 'http://link.springer.com/article/10.1007%2Fs11222-016-9696-4'>published
  version</a>, <a href = 'http://arxiv.org/abs/1507.04544'>arXiv preprint</a>).</p>
<p>Vehtari, A., Gelman, A., and Gabry, J. (2016). Pareto smoothed
  importance sampling. arXiv preprint: <a href = 'http://arxiv.org/abs/1507.02646/'>http://arxiv.org/abs/1507.02646/</a></p>
<p>Epifani, I., MacEachern, S. N., and Peruggia, M. (2008). Case-deletion
importance sampling estimators: Central limit theorems and related results.
<em>Electronic Journal of Statistics</em> <strong>2</strong>, 774-806.</p>
<p>Gelfand, A. E. (1996). Model determination using sampling-based methods. In
<em>Markov Chain Monte Carlo in Practice</em>, ed. W. R. Gilks, S. Richardson,
D. J. Spiegelhalter, 145-162. London: Chapman and Hall.</p>
<p>Gelfand, A. E., Dey, D. K., and Chang, H. (1992). Model determination using
predictive distributions with implementation via sampling-based methods. In
<em>Bayesian Statistics 4</em>, ed. J. M. Bernardo, J. O. Berger, A. P. Dawid,
and A. F. M. Smith, 147-167. Oxford University Press.</p>
<p>Gelman, A., Hwang, J., and Vehtari, A. (2014). Understanding predictive
information criteria for Bayesian models. <em>Statistics and Computing</em>
<strong>24</strong>, 997-1016.</p>
<p>Ionides, E. L. (2008). Truncated importance sampling. <em>Journal of
Computational and Graphical Statistics</em> <strong>17</strong>, 295-311.</p>
<p>Koopman, S. J., Shephard, N., and Creal, D. (2009). Testing the assumptions
behind importance sampling. <em>Journal of Econometrics</em> <strong>149</strong>, 2-11.</p>
<p>Peruggia, M. (1997). On the variability of case-deletion importance sampling
weights in the Bayesian linear model. <em>Journal of the American
Statistical Association</em> <strong>92</strong>, 199-207.</p>
<p>Stan Development Team (2016). The Stan C++ Library, Version 2.10.0.
<a href = 'http://mc-stan.org/documentation/'>http://mc-stan.org/documentation/</a>.</p>
<p>Stan Development Team (2016). RStan: the R interface to Stan, Version 2.10.1
<a href = 'http://mc-stan.org/interfaces/rstan.html'>http://mc-stan.org/interfaces/rstan.html</a>.</p>
<p>Watanabe, S. (2010). Asymptotic equivalence of Bayes cross validation and
widely application information criterion in singular learning theory.
<em>Journal of Machine Learning Research</em> <strong>11</strong>, 3571-3594.</p>
<p>Zhang, J., and Stephens, M. A. (2009). A new and efficient estimation method
for the generalized Pareto distribution. <em>Technometrics</em> <strong>51</strong>,
316-325.</p>
    

  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <h2>Contents</h2>
    <ul class="nav nav-pills nav-stacked">
      
      <li><a href="#summary">Summary</a></li>

      <li><a href="#details">Details</a></li>

      <li><a href="#psis-loo">PSIS-LOO</a></li>

      <li><a href="#pareto-k-diagnostic">Pareto k diagnostic</a></li>

      <li><a href="#references">References</a></li>
          </ul>

  </div>
</div>

      <footer>
      <div class="copyright">
  <p>Developed by Aki Vehtari, Andrew Gelman, Jonah Gabry.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
   </div>

  </body>
</html>
