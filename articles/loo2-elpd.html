<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Holdout validation and K-fold cross-validation of Stan programs with the loo package • loo</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Holdout validation and K-fold cross-validation of Stan programs with the loo package">
<meta property="og:description" content="loo">
<meta property="og:image" content="https://mc-stan.org/loo/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">loo</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.5.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Other Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="https://mc-stan.org/rstan">rstan</a>
    </li>
    <li>
      <a href="https://mc-stan.org/cmdstanr">cmdstanr</a>
    </li>
    <li>
      <a href="https://mc-stan.org/rstanarm">rstanarm</a>
    </li>
    <li>
      <a href="https://mc-stan.org/bayesplot">bayesplot</a>
    </li>
    <li>
      <a href="https://mc-stan.org/shinystan">shinystan</a>
    </li>
    <li>
      <a href="https://mc-stan.org/projpred">projpred</a>
    </li>
    <li>
      <a href="https://mc-stan.org/rstantools">rstantools</a>
    </li>
    <li>
      <a href="https://mc-stan.org/posterior">posterior</a>
    </li>
  </ul>
</li>
<li>
  <a href="https://mc-stan.org">Stan</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://twitter.com/mcmc_stan">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/stan-dev/loo">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="https://discourse.mc-stan.org/">
    <span class="fa fa-users"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="loo2-elpd_files/header-attrs-2.9/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Holdout validation and K-fold cross-validation of Stan programs with the loo package</h1>
                        <h4 class="author">Bruno Nicenboim</h4>
            
            <h4 class="date">2022-03-16</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/stan-dev/loo/blob/master/vignettes/loo2-elpd.Rmd"><code>vignettes/loo2-elpd.Rmd</code></a></small>
      <div class="hidden name"><code>loo2-elpd.Rmd</code></div>

    </div>

    
    
<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{Holdout validation and K-fold cross-validation of Stan programs with the loo package}
-->
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>This vignette demonstrates how to do holdout validation and K-fold cross-validation with <strong>loo</strong> for a Stan program.</p>
</div>
<div id="example-eradication-of-roaches-using-holdout-validation-approach" class="section level1">
<h1 class="hasAnchor">
<a href="#example-eradication-of-roaches-using-holdout-validation-approach" class="anchor"></a>Example: Eradication of Roaches using holdout validation approach</h1>
<p>This vignette uses the same example as in the vignettes <a href="http://mc-stan.org/loo/articles/loo2-example.html"><em>Using the loo package (version &gt;= 2.0.0)</em></a> and <a href="https://mc-stan.org/loo/articles/loo2-moment-matching.html"><em>Avoiding model refits in leave-one-out cross-validation with moment matching</em></a>.</p>
<div id="coding-the-stan-model" class="section level2">
<h2 class="hasAnchor">
<a href="#coding-the-stan-model" class="anchor"></a>Coding the Stan model</h2>
<p>Here is the Stan code for fitting a Poisson regression model:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">stancode</span> <span class="op">&lt;-</span> <span class="st">"
data {
  int&lt;lower=1&gt; K;
  int&lt;lower=1&gt; N;
  matrix[N,K] x;
  int y[N];
  vector[N] offset;

  real beta_prior_scale;
  real alpha_prior_scale;
}
parameters {
  vector[K] beta;
  real intercept;
}
model {
  y ~ poisson(exp(x * beta + intercept + offset));
  beta ~ normal(0,beta_prior_scale);
  intercept ~ normal(0,alpha_prior_scale);
}
generated quantities {
  vector[N] log_lik;
  for (n in 1:N)
    log_lik[n] = poisson_lpmf(y[n] | exp(x[n] * beta + intercept + offset[n]));
}
"</span></code></pre></div>
<p>Following the usual approach recommended in <a href="http://mc-stan.org/loo/articles/loo2-with-rstan.html"><em>Writing Stan programs for use with the loo package</em></a>, we compute the log-likelihood for each observation in the <code>generated quantities</code> block of the Stan program.</p>
</div>
<div id="setup" class="section level2">
<h2 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h2>
<p>In addition to <strong>loo</strong>, we load the <strong>rstan</strong> package for fitting the model. We will also need the <strong>rstanarm</strong> package for the data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mc-stan.org/rstan/">"rstan"</a></span><span class="op">)</span></code></pre></div>
<pre><code>Warning: package 'rstan' was built under R version 4.1.2</code></pre>
<pre><code>Warning: package 'StanHeaders' was built under R version 4.1.2</code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mc-stan.org/loo/">"loo"</a></span><span class="op">)</span>
<span class="va">seed</span> <span class="op">&lt;-</span> <span class="fl">9547</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="holdout-validation" class="section level1">
<h1 class="hasAnchor">
<a href="#holdout-validation" class="anchor"></a>Holdout validation</h1>
<p>For this approach, the model is first fit to the “train” data and then is evaluated on the held-out “test” data.</p>
<div id="splitting-the-data-between-train-and-test" class="section level2">
<h2 class="hasAnchor">
<a href="#splitting-the-data-between-train-and-test" class="anchor"></a>Splitting the data between train and test</h2>
<p>The data is divided between train (80% of the data) and test (20%):</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Prepare data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">roaches</span>, package <span class="op">=</span> <span class="st">"rstanarm"</span><span class="op">)</span>
<span class="va">roaches</span><span class="op">$</span><span class="va">roach1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">$</span><span class="va">roach1</span><span class="op">)</span>
<span class="va">roaches</span><span class="op">$</span><span class="va">offset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">[</span>,<span class="st">"exposure2"</span><span class="op">]</span><span class="op">)</span>
<span class="co"># 20% of the data goes to the test set:</span>
<span class="va">roaches</span><span class="op">$</span><span class="va">test</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="va">roaches</span><span class="op">$</span><span class="va">test</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">.2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="co"># data to "train" the model</span>
<span class="va">data_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">roaches</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">test</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span>,
                   x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">test</span> <span class="op">==</span> <span class="fl">0</span>,
                                         <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"roach1"</span>, <span class="st">"treatment"</span>, <span class="st">"senior"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,
                   N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">test</span> <span class="op">==</span> <span class="fl">0</span>,<span class="op">]</span><span class="op">)</span>,
                   K <span class="op">=</span> <span class="fl">3</span>,
                   offset <span class="op">=</span> <span class="va">roaches</span><span class="op">$</span><span class="va">offset</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">test</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span>,
                   beta_prior_scale <span class="op">=</span> <span class="fl">2.5</span>,
                   alpha_prior_scale <span class="op">=</span> <span class="fl">5.0</span>
                   <span class="op">)</span>
<span class="co"># data to "test" the model</span>
<span class="va">data_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">roaches</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">test</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span>,
                   x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">test</span> <span class="op">==</span> <span class="fl">1</span>,
                                         <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"roach1"</span>, <span class="st">"treatment"</span>, <span class="st">"senior"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,
                   N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">test</span> <span class="op">==</span> <span class="fl">1</span>,<span class="op">]</span><span class="op">)</span>,
                   K <span class="op">=</span> <span class="fl">3</span>,
                   offset <span class="op">=</span> <span class="va">roaches</span><span class="op">$</span><span class="va">offset</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">test</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span>,
                   beta_prior_scale <span class="op">=</span> <span class="fl">2.5</span>,
                   alpha_prior_scale <span class="op">=</span> <span class="fl">5.0</span>
                   <span class="op">)</span></code></pre></div>
</div>
<div id="fitting-the-model-with-rstan" class="section level2">
<h2 class="hasAnchor">
<a href="#fitting-the-model-with-rstan" class="anchor"></a>Fitting the model with RStan</h2>
<p>Next we fit the model to the “test” data in Stan using the <strong>rstan</strong> package:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Compile</span>
<span class="va">stanmodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stan_model.html">stan_model</a></span><span class="op">(</span>model_code <span class="op">=</span> <span class="va">stancode</span><span class="op">)</span>
<span class="co"># Fit model</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html">sampling</a></span><span class="op">(</span><span class="va">stanmodel</span>, data <span class="op">=</span> <span class="va">data_train</span>, seed <span class="op">=</span> <span class="va">seed</span>, refresh <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></code></pre></div>
<p>We recompute the generated quantities using the posterior draws conditional on the training data, but we now pass in the held-out data to get the log predictive densities for the test data. Because we are using independent data, the log predictive density coincides with the log likelihood of the test data.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gen_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-gqs.html">gqs</a></span><span class="op">(</span><span class="va">stanmodel</span>, draws <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>, data<span class="op">=</span> <span class="va">data_test</span><span class="op">)</span>
<span class="va">log_pd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_log_lik.html">extract_log_lik</a></span><span class="op">(</span><span class="va">gen_test</span><span class="op">)</span></code></pre></div>
</div>
<div id="computing-holdout-elpd" class="section level2">
<h2 class="hasAnchor">
<a href="#computing-holdout-elpd" class="anchor"></a>Computing holdout elpd:</h2>
<p>Now we evaluate the predictive performance of the model on the test data using <code><a href="../reference/elpd.html">elpd()</a></code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span><span class="va">elpd_holdout</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/elpd.html">elpd</a></span><span class="op">(</span><span class="va">log_pd</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>
Computed from 4000 by 52 log-likelihood matrix using the generic elpd function

     Estimate    SE
elpd  -1736.7 288.9
ic     3473.5 577.9</code></pre>
<p>When one wants to compare different models, the function <code><a href="../reference/loo_compare.html">loo_compare()</a></code> can be used to assess the difference in performance.</p>
</div>
</div>
<div id="k-fold-cross-validation" class="section level1">
<h1 class="hasAnchor">
<a href="#k-fold-cross-validation" class="anchor"></a>K-fold cross validation</h1>
<p>For this approach the data is divided into folds, and each time one fold is tested while the rest of the data is used to fit the model (see Vehtari et al., 2017).</p>
<div id="splitting-the-data-in-folds" class="section level2">
<h2 class="hasAnchor">
<a href="#splitting-the-data-in-folds" class="anchor"></a>Splitting the data in folds</h2>
<p>We use the data that is already pre-processed and we divide it in 10 random folds using <code>kfold_split_random</code></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Prepare data</span>
<span class="va">roaches</span><span class="op">$</span><span class="va">fold</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/kfold-helpers.html">kfold_split_random</a></span><span class="op">(</span>K <span class="op">=</span> <span class="fl">10</span>, N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="fitting-and-extracting-the-log-pointwise-predictive-densities-for-each-fold" class="section level2">
<h2 class="hasAnchor">
<a href="#fitting-and-extracting-the-log-pointwise-predictive-densities-for-each-fold" class="anchor"></a>Fitting and extracting the log pointwise predictive densities for each fold</h2>
<p>We now loop over the 10 folds. In each fold we do the following. First, we fit the model to all the observations except the ones belonging to the left-out fold. Second, we compute the log pointwise predictive densities for the left-out fold. Last, we store the predictive density for the observations of the left-out fold in a matrix. The output of this loop is a matrix of the log pointwise predictive densities of all the observations.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Prepare a matrix with the number of post-warmup iterations by number of observations:</span>
<span class="va">log_pd_kfold</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">4000</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Loop over the folds</span>
<span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">{</span>
  <span class="va">data_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">roaches</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">fold</span> <span class="op">!=</span> <span class="va">k</span><span class="op">]</span>,
                   x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">fold</span> <span class="op">!=</span> <span class="va">k</span>,
                                         <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"roach1"</span>, <span class="st">"treatment"</span>, <span class="st">"senior"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,
                   N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">fold</span> <span class="op">!=</span> <span class="va">k</span>,<span class="op">]</span><span class="op">)</span>,
                   K <span class="op">=</span> <span class="fl">3</span>,
                   offset <span class="op">=</span> <span class="va">roaches</span><span class="op">$</span><span class="va">offset</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">fold</span> <span class="op">!=</span> <span class="va">k</span><span class="op">]</span>,
                   beta_prior_scale <span class="op">=</span> <span class="fl">2.5</span>,
                   alpha_prior_scale <span class="op">=</span> <span class="fl">5.0</span>
                   <span class="op">)</span>
  <span class="va">data_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">roaches</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">fold</span> <span class="op">==</span> <span class="va">k</span><span class="op">]</span>,
                   x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">fold</span> <span class="op">==</span> <span class="va">k</span>,
                                         <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"roach1"</span>, <span class="st">"treatment"</span>, <span class="st">"senior"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,
                   N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">roaches</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">fold</span> <span class="op">==</span> <span class="va">k</span>,<span class="op">]</span><span class="op">)</span>,
                   K <span class="op">=</span> <span class="fl">3</span>,
                   offset <span class="op">=</span> <span class="va">roaches</span><span class="op">$</span><span class="va">offset</span><span class="op">[</span><span class="va">roaches</span><span class="op">$</span><span class="va">fold</span> <span class="op">==</span> <span class="va">k</span><span class="op">]</span>,
                   beta_prior_scale <span class="op">=</span> <span class="fl">2.5</span>,
                   alpha_prior_scale <span class="op">=</span> <span class="fl">5.0</span>
                   <span class="op">)</span>
  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html">sampling</a></span><span class="op">(</span><span class="va">stanmodel</span>, data <span class="op">=</span> <span class="va">data_train</span>, seed <span class="op">=</span> <span class="va">seed</span>, refresh <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
  <span class="va">gen_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-gqs.html">gqs</a></span><span class="op">(</span><span class="va">stanmodel</span>, draws <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>, data<span class="op">=</span> <span class="va">data_test</span><span class="op">)</span>
  <span class="va">log_pd_kfold</span><span class="op">[</span>, <span class="va">roaches</span><span class="op">$</span><span class="va">fold</span> <span class="op">==</span> <span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_log_lik.html">extract_log_lik</a></span><span class="op">(</span><span class="va">gen_test</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="computing-k-fold-elpd" class="section level2">
<h2 class="hasAnchor">
<a href="#computing-k-fold-elpd" class="anchor"></a>Computing K-fold elpd:</h2>
<p>Now we evaluate the predictive performance of the model on the 10 folds using <code><a href="../reference/elpd.html">elpd()</a></code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span><span class="va">elpd_kfold</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/elpd.html">elpd</a></span><span class="op">(</span><span class="va">log_pd_kfold</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>
Computed from 4000 by 262 log-likelihood matrix using the generic elpd function

     Estimate     SE
elpd  -5552.6  727.7
ic    11105.3 1455.4</code></pre>
<p>If one wants to compare several models (with <code>loo_compare</code>), one should use the same folds for all the different models.</p>
</div>
</div>
<div id="references" class="section level1">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<p>Gelman, A., and Hill, J. (2007). <em>Data Analysis Using Regression and Multilevel Hierarchical Models.</em> Cambridge University Press.</p>
<p>Stan Development Team (2020) <em>RStan: the R interface to Stan, Version 2.21.1</em> <a href="https://mc-stan.org" class="uri">https://mc-stan.org</a></p>
<p>Vehtari, A., Gelman, A., and Gabry, J. (2017). Practical Bayesian model evaluation using leave-one-out cross-validation and WAIC. <em>Statistics and Computing</em>. 27(5), 1413–1432. :10.1007/s11222-016-9696-4. Links: <a href="https://link.springer.com/article/10.1007/s11222-016-9696-4">published</a> | <a href="https://arxiv.org/abs/1507.04544">arXiv preprint</a>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Aki Vehtari, Jonah Gabry, Mans Magnusson, Yuling Yao, Paul-Christian Bürkner, Topi Paananen, Andrew Gelman.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
